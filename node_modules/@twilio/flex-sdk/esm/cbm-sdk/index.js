typeof window<"u"&&(window.global=window);import S from"lodash/isString";import Ne from"loglevel";import Fe from"lodash/isObject";import N from"lodash/isEmpty";import Me from"lodash/camelCase";import We from"lodash/transform";import je from"lodash/snakeCase";import{TaskRouterEventHandler as Oe}from"twilio-taskrouter";typeof window<"u"&&(window.global=window);function w(e,t,r,i){if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?i:r==="a"?i.call(e):i?i.value:t.get(e)}function F(e,t,r,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(e,r):n?n.value=r:t.set(e,r),r}typeof SuppressedError=="function"&&SuppressedError;var De;function b(){}b.prototype=Object.create(null);function p(){p.init.call(this)}p.EventEmitter=p,p.usingDomains=!1,p.prototype.domain=void 0,p.prototype._events=void 0,p.prototype._maxListeners=void 0,p.defaultMaxListeners=10,p.init=function(){this.domain=null,p.usingDomains&&De.active,(!this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=new b,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},p.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this};function pe(e){return e._maxListeners===void 0?p.defaultMaxListeners:e._maxListeners}p.prototype.getMaxListeners=function(){return pe(this)};function Ue(e,t,r){if(t)e.call(r);else for(var i=e.length,n=M(e,i),a=0;a<i;++a)n[a].call(r)}function Ge(e,t,r,i){if(t)e.call(r,i);else for(var n=e.length,a=M(e,n),s=0;s<n;++s)a[s].call(r,i)}function He(e,t,r,i,n){if(t)e.call(r,i,n);else for(var a=e.length,s=M(e,a),o=0;o<a;++o)s[o].call(r,i,n)}function Ve(e,t,r,i,n,a){if(t)e.call(r,i,n,a);else for(var s=e.length,o=M(e,s),c=0;c<s;++c)o[c].call(r,i,n,a)}function Qe(e,t,r,i){if(t)e.apply(r,i);else for(var n=e.length,a=M(e,n),s=0;s<n;++s)a[s].apply(r,i)}p.prototype.emit=function(e){var t,r,i,n,a,s,o,c=e==="error";if(s=this._events,s)c=c&&s.error==null;else if(!c)return!1;if(o=this.domain,c){if(t=arguments[1],o)t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t);else{if(t instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}return!1}if(r=s[e],!r)return!1;var l=typeof r=="function";switch(i=arguments.length,i){case 1:Ue(r,l,this);break;case 2:Ge(r,l,this,arguments[1]);break;case 3:He(r,l,this,arguments[1],arguments[2]);break;case 4:Ve(r,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(i-1),a=1;a<i;a++)n[a-1]=arguments[a];Qe(r,l,this,n)}return!0};function le(e,t,r,i){var n,a,s;if(typeof r!="function")throw new TypeError('"listener" argument must be a function');if(a=e._events,a?(a.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),a=e._events),s=a[t]):(a=e._events=new b,e._eventsCount=0),!s)s=a[t]=r,++e._eventsCount;else if(typeof s=="function"?s=a[t]=i?[r,s]:[s,r]:i?s.unshift(r):s.push(r),!s.warned&&(n=pe(e),n&&n>0&&s.length>n)){s.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=s.length,Je(o)}return e}function Je(e){typeof console.warn=="function"?console.warn(e):console.log(e)}p.prototype.addListener=function(e,t){return le(this,e,t,!1)},p.prototype.on=p.prototype.addListener,p.prototype.prependListener=function(e,t){return le(this,e,t,!0)};function ue(e,t,r){var i=!1;function n(){e.removeListener(t,n),i||(i=!0,r.apply(e,arguments))}return n.listener=r,n}p.prototype.once=function(e,t){if(typeof t!="function")throw new TypeError('"listener" argument must be a function');return this.on(e,ue(this,e,t)),this},p.prototype.prependOnceListener=function(e,t){if(typeof t!="function")throw new TypeError('"listener" argument must be a function');return this.prependListener(e,ue(this,e,t)),this},p.prototype.removeListener=function(e,t){var r,i,n,a,s;if(typeof t!="function")throw new TypeError('"listener" argument must be a function');if(i=this._events,!i)return this;if(r=i[e],!r)return this;if(r===t||r.listener&&r.listener===t)--this._eventsCount===0?this._events=new b:(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(n=-1,a=r.length;a-- >0;)if(r[a]===t||r[a].listener&&r[a].listener===t){s=r[a].listener,n=a;break}if(n<0)return this;if(r.length===1){if(r[0]=void 0,--this._eventsCount===0)return this._events=new b,this;delete i[e]}else Ke(r,n);i.removeListener&&this.emit("removeListener",e,s||t)}return this},p.prototype.off=function(e,t){return this.removeListener(e,t)},p.prototype.removeAllListeners=function(e){var t,r;if(r=this._events,!r)return this;if(!r.removeListener)return arguments.length===0?(this._events=new b,this._eventsCount=0):r[e]&&(--this._eventsCount===0?this._events=new b:delete r[e]),this;if(arguments.length===0){for(var i=Object.keys(r),n=0,a;n<i.length;++n)a=i[n],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=new b,this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t)do this.removeListener(e,t[t.length-1]);while(t[0]);return this},p.prototype.listeners=function(e){var t,r,i=this._events;return i?(t=i[e],t?typeof t=="function"?r=[t.listener||t]:r=ze(t):r=[]):r=[],r},p.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):he.call(e,t)},p.prototype.listenerCount=he;function he(e){var t=this._events;if(t){var r=t[e];if(typeof r=="function")return 1;if(r)return r.length}return 0}p.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function Ke(e,t){for(var r=t,i=r+1,n=e.length;i<n;r+=1,i+=1)e[r]=e[i];e.pop()}function M(e,t){for(var r=new Array(t);t--;)r[t]=e[t];return r}function ze(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}class _ extends Error{constructor(t,r){super(),this.errorData=t,this.name=t.name,this.message=r??t.message}clone(t){return new _(this.errorData,t)}}var fe;(function(e){e.EMAIL="email",e.SMS="sms",e.WHATSAPP="whatsapp"})(fe||(fe={}));const Ye="v2",Be=5e3,Xe=1e4,Ze=[{name:"INVALID_ARGUMENT",message:"One or more arguments passed were invalid."},{name:"INVALID_TOKEN",message:"The token is invalid or malformed."},{name:"TOKEN_EXPIRED",message:"CbmSdkClient's active token has expired."},{name:"GATEWAY_CONNECTION_FAILED",message:"Could not connect to Twilio's servers."},{name:"GATEWAY_DISCONNECTED",message:"Connection to Twilio's servers was lost."},{name:"INVALID_GATEWAY_MESSAGE",message:"The JSON message received was malformed."},{name:"TASKROUTER_ERROR",message:"TaskRouter failed to complete the request."}],me=Ze.reduce((e,t)=>(e[t.name]=new _(t),e),{});var E;const we=me,ge=["trace","debug","info","warn","error","silent"];var x;(function(e){e.Trace="trace",e.Debug="debug",e.Info="info",e.Warn="warn",e.Error="error",e.Silent="silent"})(x||(x={}));class W{constructor(t,r){if(E.set(this,void 0),!t)throw we.INVALID_ARGUMENT.clone("Error instantiating Logger. <string>moduleName is a required parameter.");F(this,E,Ne.getLogger(t),"f"),r&&this.setLevel(r)}trace(...t){w(this,E,"f").trace(...t)}debug(...t){w(this,E,"f").debug(...t)}info(...t){w(this,E,"f").info(...t)}warn(...t){w(this,E,"f").warn(...t)}error(...t){w(this,E,"f").error(...t)}setLevel(t){if(ge.indexOf(t)===-1)throw we.INVALID_ARGUMENT.clone("Error setting Logger level. <string>level must be one of ['trace', 'debug', 'info', 'warn', 'error', 'silent']");w(this,E,"f").setLevel(t,!1),w(this,E,"f").setDefaultLevel(t)}getLogger(){return w(this,E,"f")}getLevel(){return ge[w(this,E,"f").getLevel()]}}E=new WeakMap;function ve(e,t){for(var r=0,i=e.length-1;i>=0;i--){var n=e[i];n==="."?e.splice(i,1):n===".."?(e.splice(i,1),r++):r&&(e.splice(i,1),r--)}if(t)for(;r--;r)e.unshift("..");return e}var et=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,X=function(e){return et.exec(e).slice(1)};function Z(){for(var e="",t=!1,r=arguments.length-1;r>=-1&&!t;r--){var i=r>=0?arguments[r]:"/";if(typeof i!="string")throw new TypeError("Arguments to path.resolve must be strings");i&&(e=i+"/"+e,t=i.charAt(0)==="/")}return e=ve(ee(e.split("/"),function(n){return!!n}),!t).join("/"),(t?"/":"")+e||"."}function ye(e){var t=Ee(e),r=ct(e,-1)==="/";return e=ve(ee(e.split("/"),function(i){return!!i}),!t).join("/"),!e&&!t&&(e="."),e&&r&&(e+="/"),(t?"/":"")+e}function Ee(e){return e.charAt(0)==="/"}function tt(){var e=Array.prototype.slice.call(arguments,0);return ye(ee(e,function(t,r){if(typeof t!="string")throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))}function rt(e,t){e=Z(e).substr(1),t=Z(t).substr(1);function r(u){for(var l=0;l<u.length&&u[l]==="";l++);for(var f=u.length-1;f>=0&&u[f]==="";f--);return l>f?[]:u.slice(l,f-l+1)}for(var i=r(e.split("/")),n=r(t.split("/")),a=Math.min(i.length,n.length),s=a,o=0;o<a;o++)if(i[o]!==n[o]){s=o;break}for(var c=[],o=s;o<i.length;o++)c.push("..");return c=c.concat(n.slice(s)),c.join("/")}var it="/",nt=":";function at(e){var t=X(e),r=t[0],i=t[1];return!r&&!i?".":(i&&(i=i.substr(0,i.length-1)),r+i)}function st(e,t){var r=X(e)[2];return t&&r.substr(-1*t.length)===t&&(r=r.substr(0,r.length-t.length)),r}function ot(e){return X(e)[3]}var v={extname:ot,basename:st,dirname:at,sep:it,delimiter:nt,relative:rt,join:tt,isAbsolute:Ee,normalize:ye,resolve:Z};function ee(e,t){if(e.filter)return e.filter(t);for(var r=[],i=0;i<e.length;i++)t(e[i],i,e)&&r.push(e[i]);return r}var ct="ab".substr(-1)==="b"?function(e,t,r){return e.substr(t,r)}:function(e,t,r){return t<0&&(t=e.length+t),e.substr(t,r)};const ke=me,j="createInteraction",dt="interactionInstance",Te="interactionChannelInviteAccept",_e="interactionChannelInviteDecline",V="interactionAddParticipant",O="interactionModifyParticipant",Ce="createInteractionChannel",D="interactionChannel",Se="interactionGetChannels",be="interactionGetChannelParticipants",te="transferChannel",re="leaveChannel",ie="pauseChannel",ne="resumeChannel",Pe="pausedChannels",ae={[j]:{path:v.join("v1/Interactions")},[dt]:{path:v.join("v1","Interactions","%s")},[Te]:{path:v.join("v1","Interactions","%s","Channels","%s","Invites","%s")},[_e]:{path:v.join("v1","Interactions","%s","Channels","%s","Invites","%s")},[Se]:{path:v.join("v1","Interactions","%s","Channels")},[Ce]:{path:v.join("v1","Interactions","%s","Channels")},[D]:{path:v.join("v1","Interactions","%s","Channels","%s")},[be]:{path:v.join("v1","Interactions","%s","Channels","%s","Participants")},[V]:{path:v.join("v1","Interactions","%s","Channels","%s","Participants")},[O]:{path:v.join("v1","Interactions","%s","Channels","%s","Participants","%s")},[re]:{path:v.join("v1","Interactions","%s","Channels","%s")},[ie]:{path:v.join("v1","Interactions","%s","Channels","%s")},[ne]:{path:v.join("v1","Interactions","%s","Channels","%s")},[Pe]:{path:v.join("v1/Channels")},[te]:{path:v.join("v1","Instances","%s","Interactions","%s","Channels","%s","Transfers")}};function d(e,...t){if(!ae[e])throw ke.INVALID_ARGUMENT.clone(`Invalid route fetched <string>route "${e}" does not exist.`);if(t.length){const r={...ae[e]};if(t.length!==(r.path.match(/%s/g)||[]).length)throw ke.INVALID_ARGUMENT.clone(`Invalid number of positional arguments supplied for route ${e}`);return t.forEach(i=>{r.path=r.path.replace(/%s/,i)}),r}return ae[e]}function pt(e="",t=""){let r="";return e&&(r+=`.${e}`),t&&t!=="prod"&&(r+=`.${t}`),r}var Q;class se{constructor(t,r){if(Q.set(this,void 0),!S(t)||!t)throw new TypeError("Failed to initialize Configuration. <string>token is a required parameter.");if(this.token=t,this.logIdentifier=new Date,this.logLevel=r?.logLevel??x.Warn,F(this,Q,new W(`Configuration-${this.logIdentifier}`,this.logLevel),"f"),r?.ebServer&&(this.ebServer=r.ebServer),r?.wsServer&&(this.wsServer=r.wsServer),r?.ebServer||r?.wsServer){w(this,Q,"f").warn('"ebServer" and "wsServer" parameter will be removed in next major version. You may start using "region" and "edge".');return}const i=pt(r?.edge,r?.region);this.ebServer=`https://event-bridge${i}.twilio.com/v1/wschannels`,this.wsServer=`wss://event-bridge${i}.twilio.com/v1/wschannels`}updateToken(t){if(!S(t)||!t)throw new TypeError("To update the Twilio token, a new Twilio token must be passed in. <string>newToken is a required parameter.");this.token=t}getLogIdentifier(){return this.logIdentifier}}Q=new WeakMap;var lt="2.1.3",U;(function(e){e.Get="GET",e.Post="POST",e.Put="PUT"})(U||(U={}));const ut=lt,ht={"Content-Type":"application/json",clientVersion:ut,apiVersion:Ye};let L;async function ft(e,t){let r={...t},i;if(globalThis.AbortController!==void 0){const a=new globalThis.AbortController;r={...r,signal:a.signal},i=setTimeout(()=>a.abort(),Be)}const n=await fetch(e,r);return i!==void 0&&clearTimeout(i),n}async function Ie({method:e,server:t,url:r,params:i,token:n}){if(!L)throw new Error(`Failed to make ${e} request. Make sure 'configureRequest' is invoked prior to making a request .`);if(!r)throw new Error(`Failed to make ${e} request. <string>url is a required parameter.`);const a=JSON.stringify({url:r,params:i,method:e,token:n}),s=await ft(t,{body:a,method:U.Post,headers:ht});if(!s.ok)throw new Error(`${e} request failed: ${s.statusText}`);return(await s.json()).payload}const J=async(e,t={})=>Ie({url:e,params:t,method:U.Get,server:L.ebServer,token:L.token}),h=async(e,t)=>{if(!L)throw new Error("Failed to make POST request. Make sure `configureRequest` is invoked prior to `post` .");if(!Fe(t))throw new Error("Failed to make POST request. <object>params is a required parameter.");return Ie({url:e,params:t,method:U.Post,server:L.ebServer,token:L.token})};function mt(e){if(!(e instanceof se))throw new TypeError("Failed to initialize Request. <Configuration>userConfig is a required parameter.");L=e}function y(e){if(!e)throw new Error("No task specified for getting interaction sid");if(N(e.attributes))throw new Error("Task's attributes are not set");let t=e.attributes.flexInteractionSid;return t||(t=`KD${e.sid.slice(2)}`),t}let Le;function wt(e){Le=e||Xe}function T(e,t,r){console.debug(`Waiting for event: ${t}`);const i=new Promise((n,a)=>{setTimeout(()=>{a(new Error(`Event not received: ${t}`))},r||Le)});return Promise.race([e,i])}async function gt(e){if(!e.task)throw new Error("Failed to complete Reservation. Task is missing from Reservation.");const t=new Promise(i=>{e.once("completed",i)}),r=e.task.attributes;if(r&&r.flexInteractionChannelSid){const i=y(e.task),n=r.flexInteractionChannelSid,a=d(D,i,n).path;await h(a,{status:"closed",routing:{status:"closed"}})}else await e.complete();return T(t,"Reservation.completed")}async function vt(e){const t=new Promise((i,n)=>{e.once("accepted",i);const a=(s,o)=>{const c=o.error_data&&o.error_data.error_message;n(new _(o,`Failed to add Participant to Task sid=${e.task.sid}, Participant sid=${o.participant_sid}. Reason: ${c}`))};e.task.once("participantAddFailed",a)}),r=e.task.attributes;if(r&&r.flexInteractionChannelSid){if(!r.flexChannelInviteSid)throw new Error("flexChannelInviteSid is missing in CBM task attributes");const i=y(e.task),n=r.flexInteractionChannelSid,a=r.flexChannelInviteSid,s=d(Te,i,n,a).path,o={action:"accept",routing:{type:"taskrouter",reservation:{sid:e.sid}}};await h(s,o)}else await e.accept();return T(t,"Reservation.accepted")}async function yt(e){const t=new Promise(i=>{e.once("rejected",i)}),r=e.task.attributes;if(r&&r.flexInteractionChannelSid){if(!r.flexChannelInviteSid)throw new Error("flexChannelInviteSid is missing in CBM task attributes");const i=y(e.task),n=r.flexInteractionChannelSid,a=r.flexChannelInviteSid,s=d(_e,i,n,a).path,o={action:"decline",routing:{type:"taskrouter",reservation:{sid:e.sid}}};await h(s,o)}else await e.reject();return T(t,"Reservation.rejected")}async function Et(e){const t=new Promise(i=>{e.once("wrapup",i)}),r=e.task.attributes;if(r&&r.flexInteractionChannelSid){const i=y(e.task),n=r.flexInteractionChannelSid,a=d(D,i,n).path;await h(a,{status:"closed",routing:{status:"wrapup"}})}else await e.wrap();return T(t,"Reservation.wrapup")}class qe{constructor(t){this.taskSid=t.task_sid,this.workerSid=t.worker_sid,this.reservationSid=t.reservation_sid}}const Ae=(e,t)=>{const r=[];return e.forEach(i=>{let n;Array.isArray(i)?n=Ae(i,t):typeof i=="object"?n=K(i,t):n=i,r.push(n)}),r},K=(e,t)=>We(e,(r,i,n)=>{Array.isArray(i)?r[`${t(n)}`]=Ae(i,t):i instanceof Object&&!(i instanceof Date)?r[`${t(n)}`]=K(i,t):r[`${t(n)}`]=i},{}),kt=e=>K(e,t=>Me(t)),Tt=e=>K(e,t=>je(t));var P;(function(e){e.Agent="agent",e.Customer="customer",e.Supervisor="supervisor",e.External="external",e.Unknown="unknown"})(P||(P={}));class I{constructor(t){this.participantSid=t.participant_sid,this.channelSid=t.channel_sid,this.interactionSid=t.interaction_sid,this.type=t.type,this.channelType=t.channel_type,t.routing_properties!==null&&(this.routingProperties=new qe(t.routing_properties)),t.media_properties!==null&&(this.mediaProperties=kt(t.media_properties))}}async function _t(e,t,r={}){if(!t)throw new TypeError(`Failed to get Participants in a channel in Task sid=${e.sid}. Missing a channel sid.`);if(N(e.attributes))throw new TypeError(`Failed to get Participants in a channel in Task sid=${e.sid}. Missing attributes.`);const i=y(e),n=d(be,i,t).path,a={...r},s=await J(n,a);if(s.participants)return s.participants.map(o=>new I({...o,participant_sid:o.sid,channel_type:s.channel_type}));throw new TypeError(`Failed to get Participants in a channel in Task sid=${e.sid}. Response does not contain participants object.`)}async function $(e){if(N(e.attributes))throw new Error("Task attributes missing - getChannels expects the task to have attributes");const t=y(e),r=d(Se,t).path,i=await J(r),n=[];return i.channels&&i.channels.forEach(a=>{n.push({...a,interactionSid:a.interaction_sid,mediaSid:a.media_sid})}),n}async function Ct(e){const t=(await $(e)).find(o=>o.type==="voice");if(!t)throw new TypeError(`Failed to close the conference in a channel in Task sid=${e.sid}. The task is expected to have a voice channel.`);const r=y(e),i=d(D,r,t.sid).path,n={status:"closed"};let a;const s=new Promise(o=>{e.once("wrapup",()=>{o(a)})});return a=await h(i,n),T(s,"Task.wrapup")}async function St(e,t,r){if(!t)throw new TypeError("Error calling method setEndConferenceOnExit(). <string>participantSid is a required parameter.");if(typeof e.attributes>"u")throw new Error("Task's attributes are not set");const i=(await $(e)).find(s=>s.type==="voice").sid,n=y(e),a=d(O,n,i,t).path;return h(a,{media_properties:{end_conference_on_exit:r}})}async function bt(e,t,r,i){if(!t)throw new TypeError(`Error calling method ${i}(). <string>participantSid is a required parameter.`);if(typeof e.attributes>"u")throw new Error("Task's attributes are not set");const n=(await $(e)).find(o=>o.type==="voice").sid,a=y(e),s=d(O,a,n,t).path;return h(s,{media_properties:r})}async function xe(e,t,r,i){let n;const a=new Promise((s,o)=>{const c=(l,f)=>{f.participant_sid===n?.sid&&(e.removeListener("participantModified",c),s(new I(f)))};e.on("participantModified",c);const u=(l,f)=>{f.participant_sid===n?.sid&&(e.removeListener("participantModifyFailed",u),o(new _(f,`Failed to modify Participant to Task sid=${e.sid}`)))};e.on("participantModifyFailed",u)});return n=await bt(e,t,r,i),T(a,"Task.participantModified")}function Pt(e,t){return xe(e,t,{hold:!0},"holdParticipant")}function It(e,t){return xe(e,t,{hold:!1},"unHoldParticipant")}function R(e){return e.participant_sid}var g;(function(e){e.Email="email",e.Sms="sms",e.WhatsApp="whatsapp",e.Web="web",e.Voice="voice",e.Messenger="messenger",e.Chat="chat",e.Gbm="gbm",e.Video="video"})(g||(g={}));async function z(e,t){let r;const i=new Promise((o,c)=>{const u=(f,m)=>{R(m)===r?.sid&&(e.removeListener("participantAdded",u),o(new I(m)))};e.on("participantAdded",u);const l=(f,m)=>{if(R(m)===r?.sid){e.removeListener("participantAddFailed",l);const A=m.error_data&&m.error_data.error_message;c(new _(m,`Failed to add Participant to Task sid=${e.sid}. Reason: ${A}`))}};e.on("participantAddFailed",l)}),n=y(e),a=e.attributes.flexInteractionChannelSid,s=d(V,n,a).path;return r=await h(s,t),T(i,"Task.participantAdded")}async function Lt(e,t){const r=e.attributes;if(!(r&&r.channelType==="email"))throw new Error("Wrong channel type - addParticipant expects the task to have an email channel");if(!r||!r.flexInteractionChannelSid)throw new TypeError(`Failed to add Participant to Task sid=${e.sid}. Missing flexInteractionChannelSid.`);const i={type:P.Customer,media_properties:{level:t.level,name:t.toName,address:t.address,type:g.Email}};return z(e,i)}async function qt(e,t){if(!S(t.from)||!t.from)throw new TypeError("Error calling method addSmsParticipant(). <string>from is a required parameter.");if(!S(t.to)||!t.to)throw new TypeError("Error calling method addSmsParticipant(). <string>to is a required parameter.");const r=e.attributes;if(!(r&&r.channelType==="sms"))throw new Error("Wrong channel type - addSmsParticipant expects the task to have a sms channel");if(!(r&&r.flexInteractionChannelSid))throw new Error(`Failed to add Participant to Task sid=${e.sid}. Missing flexInteractionChannelSid.`);const i={type:P.Customer,media_properties:{address:t.to,proxy_address:t.from,type:g.Sms}};return z(e,i)}async function At(e,t){if(!S(t.from)||!t.from)throw new TypeError("Error calling method addWhatsAppParticipant(). <string>from is a required parameter.");if(!S(t.to)||!t.to)throw new TypeError("Error calling method addWhatsAppParticipant(). <string>to is a required parameter.");const r=e.attributes;if(!(r&&r.channelType==="whatsapp"))throw new Error("Wrong channel type - addWhatsAppParticipant expects the task to have a whatsapp channel");if(!(r&&r.flexInteractionChannelSid))throw new Error(`Failed to addWhatsAppParticipant to Task sid=${e.sid}. Missing flexInteractionChannelSid.`);const i={type:P.Customer,media_properties:{address:t.to,proxy_address:t.from,type:g.WhatsApp}};return z(e,i)}async function xt(e,t){if(!S(t.identity)||!t.identity)throw new TypeError("Error calling method addWebChatParticipant(). <string>participantIdentity is a required parameter.");const r=e.attributes;if(!(r&&r.channelType==="web"))throw new Error("Wrong channel type - addWebChatParticipant expects the task to have a web channel");if(!(r&&r.flexInteractionChannelSid))throw new Error(`Failed to addWebChatParticipant to Task sid=${e.sid}. Missing flexInteractionChannelSid.`);const i={type:P.Customer,media_properties:{identity:t.identity,type:g.Web}};return z(e,i)}async function $t(e,t,r,i){const n={type:r,media_properties:{...i&&{identity:i}}},a=d(V,e,t).path,s=await h(a,n);return{sid:s.sid,type:s.type,channelSid:s.channel_sid,mediaProperties:s.media_properties||null}}async function Rt(e,t){if(N(e.attributes))throw new TypeError(`Failed to addVoiceParticipant in Task sid=${e.sid}. Missing attributes.`);let r;const i=new Promise((u,l)=>{const f=(B,k)=>{k.participant_sid===r?.sid&&(e.removeListener("participantAdded",f),u(new I(k)))},m=(B,k)=>{k.participant_sid===r?.sid&&(e.removeListener("participantAddFailed",m),l(new _(k,`Failed to add Participant from Task sid=${e.sid}.`)))},A=(B,k)=>{k.participant_sid===r?.sid&&(e.removeListener("participantRemoved",A),u(new I(k)))},C=(B,k)=>{k.participant_sid===r?.sid&&(e.removeListener("participantRemoved",C),l(new _(k,`Failed to remove Participant from Task sid=${e.sid}.`)))};e.on("participantAdded",f),e.on("participantAddFailed",m),e.on("participantRemoved",A),e.on("participantRemoveFailed",C)}),n=y(e),a=(await $(e)).find(u=>u.type==="voice").sid,s=d(V,n,a).path,o={type:t.type,media_properties:{coordinates:{from:t.from,to:t.to},...t.mediaProperties&&{...Tt(t.mediaProperties)}}};if(t.type===P.Agent&&t.routingProperties){const{taskSid:u,workerSid:l,reservationSid:f}=t.routingProperties;o.routing_properties={task_sid:u,worker_sid:l,reservation_sid:f}}r=await h(s,o);const c=5*6e4;return{pendingParticipantResponse:r,waitForParticipantToSettle:T(i,"Task.participantAdded",c)}}async function Nt(e,t,r={}){if(N(e.attributes)?.flexInteractionChannelSid)throw new Error(`Failed to remove a participant from the Task sid=${e.sid}. Missing flexInteractionChannelSid.`);let i;const n=new Promise((u,l)=>{const f=(A,C)=>{R(C)===i?.sid&&(e.removeListener("participantRemoved",f),u(new I(C)))};e.on("participantRemoved",f);const m=(A,C)=>{R(C)===i?.sid&&(e.removeListener("participantRemoveFailed",m),l(new _(C,`Failed to remove Participant from Task sid=${e.sid}. Reason: ${C.reason}`)))};e.on("participantRemoveFailed",m)}),a=e.attributes.flexInteractionChannelSid,s=y(e),o=d(O,s,a,t).path,c={status:"closed",...r};return i=await h(o,c),T(n,"Task.participantRemoved")}async function Ft(e,t){let r;const i=new Promise((o,c)=>{const u=(f,m)=>{R(m)===r?.sid&&(e.removeListener("participantRemoved",u),o(new I(m)))};e.on("participantRemoved",u);const l=(f,m)=>{R(m)===r?.sid&&(e.removeListener("participantRemoveFailed",l),c(new _(m,`Failed to remove Participant from Task sid=${e.sid}. Reason: ${m.reason}`)))};e.on("participantRemoveFailed",l)}),n=(await $(e)).find(o=>o.type==="voice").sid,a=y(e),s=d(O,a,n,t).path;return r=await h(s,{status:"closed"}),T(i,"Task.participantRemoved")}async function Mt(e,t,r,i){if(!i.to)throw new TypeError("Error calling method createTask(). <string>to is a required parameter.");if(!i.from)throw new TypeError("Error calling method createTask(). <string>from is a required parameter.");if(!t)throw new TypeError("Error calling method createTask(). <string>workflowSid is a required parameter.");if(!r)throw new TypeError("Error calling method createTask(). <string>taskQueueSid is a required parameter.");const n=d(j).path,a={channel:{type:g.Email,initiated_by:"agent",properties:{type:g.Email,direction:"outbound",from_name:i.fromName||"",from:i.from},participants:[{level:"to",name:i.toName||"",address:i.to,type:g.Email}]},routing:{type:"TaskRouter",properties:{workspace_sid:e.workspaceSid,workflow_sid:t,task_channel_unique_name:"email",queue_sid:r,worker_sid:e.sid,attributes:{}}}},{taskChannelSid:s,taskUniqueChannelName:o}=i;a.taskChannelSid=s,a.taskUniqueChannelName=o,a.routing.properties.attributes=i.attributes??{};const c=await h(n,a);return{interactionSid:c.sid,taskSid:c.routing.properties.sid}}async function Wt(e,t,r,i){if(!i.to)throw new TypeError("Error calling method createTask(). <string>to is a required parameter.");if(!i.from)throw new TypeError("Error calling method createTask(). <string>from is a required parameter.");if(!t)throw new TypeError("Error calling method createTask(). <string>workflowSid is a required parameter.");if(!r)throw new TypeError("Error calling method createTask(). <string>taskQueueSid is a required parameter.");const n=d(j).path,a={channel:{type:g.Sms,initiated_by:"agent",properties:{type:g.Sms},participants:[{address:i.to,proxy_address:i.from}]},routing:{type:"TaskRouter",properties:{workspace_sid:e.workspaceSid,workflow_sid:t,task_channel_unique_name:"sms",queue_sid:r,worker_sid:e.sid,attributes:{customerName:i.toName||"",customerAddress:i.to}}}},{taskChannelSid:s,taskUniqueChannelName:o}=i;a.taskChannelSid=s,a.taskUniqueChannelName=o,a.routing.properties.attributes={...a.routing.properties.attributes,...i.attributes};const c=await h(n,a);return{interactionSid:c.sid,taskSid:c.routing.properties.sid}}async function jt(e,t,r,i){if(!i.to)throw new TypeError("Error calling method createTask(). <string>to is a required parameter.");if(!i.from)throw new TypeError("Error calling method createTask(). <string>from is a required parameter.");if(!t)throw new TypeError("Error calling method createTask(). <string>workflowSid is a required parameter.");if(!r)throw new TypeError("Error calling method createTask(). <string>taskQueueSid is a required parameter.");const n=d(j).path,a={channel:{type:g.WhatsApp,initiated_by:"agent",properties:{type:g.WhatsApp},participants:[{address:i.to,proxy_address:i.from}]},routing:{type:"TaskRouter",properties:{workspace_sid:e.workspaceSid,workflow_sid:t,queue_sid:r,worker_sid:e.sid,attributes:{customerName:i.toName||"",customerAddress:i.to}}}},{taskChannelSid:s,taskUniqueChannelName:o}=i;a.taskChannelSid=s,a.taskUniqueChannelName=o,a.routing.properties.attributes={...a.routing.properties.attributes,...i.attributes};const c=await h(n,a);return{interactionSid:c.sid,taskSid:c.routing.properties.sid}}async function Ot(e,t,r,i){if(!i.to)throw new TypeError("Error calling method createTask(). <string>to is a required parameter.");if(!t)throw new TypeError("Error calling method createTask(). <string>workflowSid is a required parameter.");if(!r)throw new TypeError("Error calling method createTask(). <string>taskQueueSid is a required parameter.");const n=d(j).path,a={channel:{type:g.Web,initiated_by:"agent",properties:{type:g.Web},participants:[{identity:i.to}]},routing:{type:"TaskRouter",properties:{workspace_sid:e.workspaceSid,workflow_sid:t,task_channel_unique_name:"chat",queue_sid:r,worker_sid:e.sid,attributes:{identity:i.to}}}},{taskChannelSid:s,taskUniqueChannelName:o}=i;a.taskChannelSid=s,a.taskUniqueChannelName=o,a.routing.properties.attributes={...a.routing.properties.attributes,...i.attributes};const c=await h(n,a);return{interactionSid:c.sid,taskSid:c.routing.properties.sid}}async function Dt(e,t,r,i){if(!e)throw new TypeError("Error calling method leaveConversation(). <string>interactionSid is a required parameter.");if(!t)throw new TypeError("Error calling method leaveConversation(). <string>channelSid is a required parameter.");const n=d(re,e,t).path;return h(n,{status:r,routing:{status:i}})}async function Ut(e,t,r,i){if(!e)throw new TypeError("Error calling method leaveChannel(). <string>interactionSid is a required parameter.");if(!t)throw new TypeError("Error calling method leaveChannel(). <string>channelSid is a required parameter.");const n=d(re,e,t).path;return h(n,{status:r,routing:{status:i}})}async function Gt(e,t,r,i){const n=d(Ce,e).path,a={interactionSid:e,type:t,initiated_by:r,properties:{type:t},participants:i},s=await h(n,a);return{sid:s.sid,interactionSid:s.interaction_sid,type:s.type,status:s.status,mediaSid:s.media_sid,mediaProperties:s.media_properties}}async function $e(e,t,r){const i=d(D,e,t).path;return h(i,{status:r})}async function Ht(e,t){return $e(e,t,"close")}async function Vt(e,t,r,i){if(!e)throw new TypeError("Error calling method pauseEmailConversation(). <string>interactionSid is a required parameter.");if(!t)throw new TypeError("Error calling method pauseEmailConversation(). <string>channelSid is a required parameter.");if(!r)throw new TypeError("Error calling method pauseEmailConversation(). <string>taskStatus is a required parameter.");const n=d(ie,e,t).path;return h(n,{status:r,routing:{status:i}})}async function Qt(e,t,r,i){if(!e)throw new TypeError("Error calling method pauseChannel(). <string>interactionSid is a required parameter.");if(!t)throw new TypeError("Error calling method pauseChannel(). <string>channelSid is a required parameter.");if(!r)throw new TypeError("Error calling method pauseChannel(). <string>taskStatus is a required parameter.");const n=d(ie,e,t).path;return h(n,{status:r,routing:{status:i}})}async function Jt(e,t,r){if(!e)throw new TypeError("Error calling method resumeEmailConversation(). <string>interactionSid is a required parameter.");if(!t)throw new TypeError("Error calling method resumeEmailConversation(). <string>channelSid is a required parameter.");if(!r)throw new TypeError("Error calling method resumeEmailConversation(). <string>taskStatus is a required parameter.");const i=d(ne,e,t).path;return h(i,{status:r})}async function Kt(e,t,r){if(!e)throw new TypeError("Error calling method resumeChannel(). <string>interactionSid is a required parameter.");if(!t)throw new TypeError("Error calling method resumeChannel(). <string>channelSid is a required parameter.");if(!r)throw new TypeError("Error calling method resumeChannel(). <string>taskStatus is a required parameter.");const i=d(ne,e,t).path;return h(i,{status:r})}async function Re(e){const t=d(Pe).path;return J(t,{status:"pause",pageSize:e||50})}async function zt(e,t){if(!e)throw new TypeError("Error calling method getPausedEmailConversations(). <string>status is a required parameter.");return Re(t)}function G(e){throw new TypeError(`Error calling method transferChannel(). <string>${e} is a required parameter.`)}function Yt(e,t,r,i,n){e||G("instanceSId"),t||G("interactionSid"),r||G("channelSid"),i||G("from"),n||G("to")}async function Bt(e,t,r,i,n,a,s="cold"){Yt(e,t,r,i,n);const o=d(te,e,t,r).path;return h(o,{noteSid:a,type:s,from:i,to:n})}function oe(e){throw new TypeError(`Error calling method getChannelTransfers(). <string>${e} is a required parameter.`)}function Xt(e,t,r){e||oe("instanceSId"),t||oe("interactionSid"),r||oe("channelSid")}async function Zt(e,t,r){Xt(e,t,r);const i=d(te,e,t,r).path,n=await J(i);if(!Array.isArray(n))throw n;return n.map(a=>({sid:a.sid,accountSid:a.account_sid,instanceSid:a.instance_sid,interactionSid:a.interaction_sid,channelSid:a.channel_sid,type:a.type,from:a.from,to:a.to,status:a.status,executionSid:a.note_sid,noteSid:a.note_sid,summarySid:a.note_sid,reason:a.note_sid,dateCreated:a.date_created,dateUpdated:a.date_updated}))}var Y,q,H;class er extends p{constructor(t,r){if(super(),Y.set(this,void 0),q.set(this,void 0),H.set(this,void 0),this.addEmailParticipant=Lt,this.addSmsParticipant=qt,this.addWhatsAppParticipant=At,this.addWebChatParticipant=xt,this.addVoiceParticipant=Rt,this.addInteractionChannelParticipant=$t,this.removeParticipant=Nt,this.removeVoiceParticipant=Ft,this.getChannels=$,this.getParticipants=_t,this.acceptReservation=vt,this.completeReservation=gt,this.holdParticipant=Pt,this.unHoldParticipant=It,this.endConference=Ct,this.setEndConferenceOnExit=St,this.rejectReservation=yt,this.wrapReservation=Et,this.createEmailTask=Mt,this.createWhatsAppTask=jt,this.createSmsTask=Wt,this.createWebTask=Ot,this.leaveConversation=Dt,this.leaveChannel=Ut,this.createInteractionChannel=Gt,this.updateInteractionChannel=$e,this.closeInteractionChannel=Ht,this.pauseEmailConversation=Vt,this.pauseChannel=Qt,this.resumeEmailConversation=Jt,this.resumeChannel=Kt,this.getPausedEmailConversations=zt,this.getPausedChannels=Re,this.transferChannel=Bt,this.getChannelTransfers=Zt,!S(t)||!t)throw new TypeError("Failed to instantiate CbmSdkClient. <string>token is a required parameter.");F(this,Y,r.logLevel||x.Error,"f"),F(this,q,new se(t,r),"f"),F(this,H,new W(`Worker-${w(this,q,"f").getLogIdentifier()}`,w(this,Y,"f")),"f"),mt(w(this,q,"f")),wt(r.eventsTimeout)}getLogger(t){return new W(`${t}`,w(this,q,"f").logLevel)}updateToken(t){if(!S(t)||!t)throw new TypeError("To update the Twilio token, a new Twilio token must be passed in. <string>newToken is a required parameter.");w(this,H,"f").info("Proceeding to update the CbmSdkClient's current active token with a new token."),w(this,H,"f").debug(`New token: ${t}`);try{w(this,q,"f").updateToken(t),this.emit("tokenUpdated")}catch(r){this.emit("error",r)}}}Y=new WeakMap,q=new WeakMap,H=new WeakMap;var ce;(function(e){e.Active="active",e.Setup="setup",e.Closed="closed",e.Failed="failed"})(ce||(ce={}));var de;(function(e){e.To="to",e.CC="cc",e.BCC="bcc"})(de||(de={}));const tr={"participant.added":"participantAdded","participant.add.failed":"participantAddFailed","participant.removed":"participantRemoved","participant.remove.failed":"participantRemoveFailed","participant.modified":"participantModified","participant.modify.failed":"participantModifyFailed"};class rr extends Oe{constructor(t,r={}){super(t,r),this._worker=t,this._logLevel=r.logLevel||x.Error,this._log=new W("ParticipantEventHandler",this._logLevel)}getTREventsToHandlerMapping(){const t=super.getTREventsToHandlerMapping();return t["participant.added"]="_participantEventHandler",t["participant.add.failed"]="_participantEventHandler",t["participant.removed"]="_participantEventHandler",t["participant.remove.failed"]="_participantEventHandler",t["participant.modified"]="_participantEventHandler",t["participant.modify.failed"]="_participantEventHandler",t}_participantEventHandler(t,r){const i=tr[r];this._log.info(`Worker ${this._worker.sid} received Event: ${r} mapped to ${i}.`);const n=t.routing_properties&&t.routing_properties.task_sid;if(n){this._log.debug(`Task sid ${n}, proceeding to get tasks.`);const a=this._worker._dataServices.reservationsEntity.getTasks(n);a&&a.length>0?(a[0]._emitEvent(i,t),this._log.debug(`Emitted event ${i} with data ${JSON.stringify(t)}`)):this._log.warn(`The task ${n} specified by Event: participant.${i} does not exist in 
                    Worker ${this._worker.sid} Reservations map. Skipping event with data ${JSON.stringify(t)}.`)}else throw this._log.error(`Event: participant. ${i} did not contain a Task sid. 
              Unable to emit event for Worker ${this._worker.sid}. Data ${JSON.stringify(t)}`),new Error(`Failed to emit event for Worker ${this._worker.sid}.`)}}export{I as CbmParticipant,er as CbmSdk,ce as ChannelStatus,se as Configuration,x as LogLevel,W as Logger,g as MediaChannelType,rr as ParticipantEventHandler,de as ParticipantLevel,P as ParticipantType,qe as RoutingProperties};
//# sourceMappingURL=index.js.map
