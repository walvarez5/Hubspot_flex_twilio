typeof window<"u"&&(window.global=window);import{__classPrivateFieldSet as c,__classPrivateFieldGet as o}from"../../../../node_modules/tslib/tslib.es6.js";import{stringify as x}from"query-string";import{FederatedAuthServiceImpl as y}from"../../../backend/generated/FederatedAuth/api/federatedAuth.service.js";import{PreviewFlexTokenServiceImpl as F}from"../../../backend/generated/PreviewFlex/api/previewFlexToken.service.js";import{ClientOptionsStore as T}from"../../client/ClientOptions/ClientOptionsStore.js";import{getEnvironmentConfig as _}from"../../config/EnvironmentConfig/EnvironmentConfigImpl.js";import"../../logger/Logger/LogEntry.js";import{LoggerName as R}from"../../logger/Logger/LoggerName.js";import{getLogger as O}from"../../logger/LoggerFactory/getLogger.js";import"../../logger/LoggerFactory/LoggerConfigImpl.js";import"../../error/FlexSdkError/FlexSdkError.js";import{InternalError as b}from"../../error/InternalError/InternalError.js";import"../../error/ErrorCode/ErrorCodes.js";import"../../error/ErrorCode/InternalErrorCodes.js";import"../../error/ErrorCode/ErrorCodeHelper.js";import"../../error/ErrorSeverity/ErrorSeverity.js";import"../../storage/LocalStorage/LocalStorageKeys.js";import"../../config/AccountConfig/AccountConfigImpl/AccountConfigDataContainer/AccountConfigDataContainer.js";import"../../reporter/ErrorReporter.js";import"../../storage/LocalStorage/LocalStorageImpl.js";import"../../../backend/generated/Configuration/api/configuration.service.js";import{assertNotEmptyString as N}from"../../../utils/assert.js";import{AuthenticatorDataContainerImpl as P}from"../AuthenticatorDataContainer/AuthenticatorDataContainerImpl.js";import{getSSOLoginRequestBody as D}from"../AuthenticatorHelpers/getSSOLoginRequestBody.js";import{generateProofKey as $}from"../AuthenticatorHelpers/generateProofKey.js";import{convertDateStringValuesToDate as E}from"../../../utils/processHttpAdapterResponse.js";import{parseRegionForTwilsock as L,buildRegionalHost as C}from"../../../utils/regionUtil.js";var a,f,s,h,r;class M{constructor(e){a.set(this,void 0),f.set(this,void 0),s.set(this,void 0),h.set(this,void 0),r.set(this,void 0),c(this,f,O(e)(R.Auth),"f"),c(this,a,e.getInstanceOf(P),"f"),c(this,r,e.getInstanceOf(T),"f"),c(this,s,e.getInstanceOf(y),"f"),c(this,h,e.getInstanceOf(F),"f")}async getIdpUrl(e){N(e.redirectUrl,"redirect url");const i=D(e),t=o(this,a,"f").accountSid,n=await o(this,s,"f").getIdpUrl(t,i);if(!n.location)throw o(this,f,"f").error("No redirect location from /authenticate request, data: ",n),new b("Invalid response from /authenticate endpoint");return n.location}async validateToken(e){const i=o(this,a,"f").accountSid,t=await o(this,s,"f").validateToken(i,{token:e},{token:e});return{roles:t.roles,valid:t.valid,dateExpired:t.expiration,identity:t.identity,flexUserSid:t.flexUserSid}}async refreshToken(e){const i=o(this,a,"f").accountSid,t=await o(this,s,"f").refreshToken(i,{token:e});return{token:t.token,dateExpired:t.expiration}}async getLoginDetails(e,i,t){const n=_(),{region:g,regionNonFlex:u}=n||{},l=u||o(this,r,"f").regionNonFlex||g||o(this,r,"f").region,p=C(l||""),S=`https://flex${p}.twilio.com/callback`,w=`https://login.flex.${L(l)}.twilio.com/authorize`,k=`https://services${p}.twilio.com/v1/Flex/Authentication/Callback`,v=t||S,{nonce:d,codeChallenge:m,state:I,codeVerifier:A}=await $(i,v),U=x({client_id:e,connection:i,response_type:"code",state:I,nonce:d,redirect_uri:encodeURIComponent(k),code_challenge_method:"S256",code_challenge:m,scope:encodeURIComponent("openid offline_access profile email")},{encode:!1,sort:!1});return{loginUrl:`${w}?${U}`,nonce:d,codeChallenge:m,state:I,codeVerifier:A}}async exchangeToken(e){const{clientId:i,authCode:t,codeVerifier:n,nonce:g,state:u}=e,l=_(),{region:p,regionNonFlex:S}=l||{},w=S||o(this,r,"f").regionNonFlex||p||o(this,r,"f").region,v=`https://services${C(w||"")}.twilio.com/v1/Flex/Authentication/Callback`,d=new URLSearchParams({ClientId:i,CodeVerifier:n,AuthCode:t,RedirectUrl:v,State:u,Nonce:g}).toString(),m=await o(this,h,"f").createFlexAuth0Token(d);return E(m)}}a=new WeakMap,f=new WeakMap,s=new WeakMap,h=new WeakMap,r=new WeakMap;export{M as AuthenticatorImpl};
//# sourceMappingURL=AuthenticatorImpl.js.map
