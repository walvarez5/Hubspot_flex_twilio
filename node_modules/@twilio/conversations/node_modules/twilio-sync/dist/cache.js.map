{"version":3,"file":"cache.js","sources":["../src/cache.ts"],"sourcesContent":["import { TreeMap } from './utils/tree';\n\ninterface CacheEntry<T> {\n  value: T;\n  revision: number;\n  isValid: boolean;\n}\n\nclass Entry<T> implements CacheEntry<T> {\n  value: T;\n  revision: number;\n\n  constructor(value: T, revision: number) {\n    this.value = value;\n    this.revision = (revision || 0);\n  }\n\n  get isValid(): boolean {\n    return true;\n  }\n}\n\nclass Tombstone<T> implements CacheEntry<T> {\n  value: T;\n  revision: number;\n\n  constructor(revision: number) {\n    this.revision = revision;\n  }\n\n  get isValid(): boolean {\n    return false;\n  }\n}\n\nclass Cache<K, V> {\n  public readonly items: TreeMap<K, CacheEntry<V>>;\n\n  constructor() {\n    this.items = new TreeMap<K, CacheEntry<V>>();\n  }\n\n  store(key: K, value: V, revision: number): V {\n    let entry = this.items.get(key);\n    if (entry && entry.revision > revision) {\n      if (entry.isValid) {\n        return entry.value;\n      }\n      return null;\n    }\n    this.items.set(key, new Entry<V>(value, revision));\n    return value;\n  }\n\n  delete(key: K, revision: number, force: boolean = false): void {\n    let curr = this.items.get(key);\n    if (!curr || curr.revision < revision ||\n      (curr && force === true) /* forced delete when revision is unknown */) {\n      this.items.set(key, new Tombstone<V>(revision));\n    }\n  }\n\n  isKnown(key: K, revision: number): boolean {\n    let curr = this.items.get(key);\n    return curr && curr.revision >= revision;\n  }\n\n  get(key: K): V {\n    let entry = this.items.get(key);\n    if (entry && entry.isValid) {\n      return entry.value;\n    }\n    return null;\n  }\n\n  has(key: K): boolean {\n    let entry = this.items.get(key);\n    return entry && entry.isValid;\n  }\n\n  forEach(callbackfn: (key: K, value: V) => void): void {\n    if (this.items) {\n      for (let [key, entry] of this.items) {\n        if (entry.isValid) {\n          callbackfn(key, entry.value);\n        }\n      }\n    }\n  }\n}\n\nexport { Cache };\nexport default Cache;\n"],"names":["TreeMap"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQA,MAAM,KAAK;IAIT,YAAY,KAAQ,EAAE,QAAgB;QACpC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,QAAQ,IAAI,QAAQ,IAAI,CAAC,CAAC,CAAC;KACjC;IAED,IAAI,OAAO;QACT,OAAO,IAAI,CAAC;KACb;CACF;AAED,MAAM,SAAS;IAIb,YAAY,QAAgB;QAC1B,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;KAC1B;IAED,IAAI,OAAO;QACT,OAAO,KAAK,CAAC;KACd;CACF;AAED,MAAM,KAAK;IAGT;QACE,IAAI,CAAC,KAAK,GAAG,IAAIA,YAAO,EAAoB,CAAC;KAC9C;IAED,KAAK,CAAC,GAAM,EAAE,KAAQ,EAAE,QAAgB;QACtC,IAAI,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAChC,IAAI,KAAK,IAAI,KAAK,CAAC,QAAQ,GAAG,QAAQ,EAAE;YACtC,IAAI,KAAK,CAAC,OAAO,EAAE;gBACjB,OAAO,KAAK,CAAC,KAAK,CAAC;aACpB;YACD,OAAO,IAAI,CAAC;SACb;QACD,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,KAAK,CAAI,KAAK,EAAE,QAAQ,CAAC,CAAC,CAAC;QACnD,OAAO,KAAK,CAAC;KACd;IAED,MAAM,CAAC,GAAM,EAAE,QAAgB,EAAE,QAAiB,KAAK;QACrD,IAAI,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAC/B,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,QAAQ,GAAG,QAAQ;aAClC,IAAI,IAAI,KAAK,KAAK,IAAI,CAAC,+CAA+C;YACvE,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,SAAS,CAAI,QAAQ,CAAC,CAAC,CAAC;SACjD;KACF;IAED,OAAO,CAAC,GAAM,EAAE,QAAgB;QAC9B,IAAI,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAC/B,OAAO,IAAI,IAAI,IAAI,CAAC,QAAQ,IAAI,QAAQ,CAAC;KAC1C;IAED,GAAG,CAAC,GAAM;QACR,IAAI,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAChC,IAAI,KAAK,IAAI,KAAK,CAAC,OAAO,EAAE;YAC1B,OAAO,KAAK,CAAC,KAAK,CAAC;SACpB;QACD,OAAO,IAAI,CAAC;KACb;IAED,GAAG,CAAC,GAAM;QACR,IAAI,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAChC,OAAO,KAAK,IAAI,KAAK,CAAC,OAAO,CAAC;KAC/B;IAED,OAAO,CAAC,UAAsC;QAC5C,IAAI,IAAI,CAAC,KAAK,EAAE;YACd,KAAK,IAAI,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,IAAI,CAAC,KAAK,EAAE;gBACnC,IAAI,KAAK,CAAC,OAAO,EAAE;oBACjB,UAAU,CAAC,GAAG,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC;iBAC9B;aACF;SACF;KACF;;;;;;"}