{"version":3,"file":"subscriptions.js","sources":["../src/subscriptions.ts"],"sourcesContent":["import { Backoff } from '@twilio/operation-retrier';\nimport { SyncError } from './utils/syncerror';\nimport log from './utils/logger';\n\nimport { SyncEntity } from './entity';\nimport { Configuration, Network } from './interfaces/services';\n\nimport { TransportUnavailableError } from 'twilsock';\n\n/**\n * A data container used by the Subscriptions class to track subscribed entities' local\n * representations and their state.\n */\nclass SubscribedEntity {\n  private readonly localObject: SyncEntity;\n  pendingCorrelationId: number;\n  pendingAction: string;\n  rejectedWithError: any;\n  retryCount: number;\n\n  private established: boolean;\n\n  constructor(entity: SyncEntity) {\n    this.localObject = entity;\n    this.pendingCorrelationId = null;\n    this.pendingAction = null;\n    this.established = false;\n    this.retryCount = 0;\n  }\n\n  get sid(): string {\n    return this.localObject.sid;\n  }\n\n  get type(): string {\n    return this.localObject.type;\n  }\n\n  get lastEventId(): number {\n    return this.localObject.lastEventId;\n  }\n\n  // below properties are specific to Insights only\n  get indexName(): string {\n    return this.localObject.indexName;\n  }\n\n  get queryString(): string {\n    return this.localObject.queryString;\n  }\n\n  get isEstablished(): boolean {\n    return this.established;\n  }\n\n  update(event, isStrictlyOrdered) {\n    this.localObject._update(event, isStrictlyOrdered);\n  }\n\n  updatePending(action: Action, correlationId: number) {\n    this.pendingAction = action;\n    this.pendingCorrelationId = correlationId;\n  }\n\n  reset() {\n    this.updatePending(null, null);\n    this.retryCount = 0;\n    this.established = false;\n    this.setSubscriptionState('none');\n  }\n\n  markAsFailed(message) {\n    this.rejectedWithError = message.error;\n    this.updatePending(null, null);\n    this.localObject.reportFailure(\n      new SyncError(`Failed to subscribe on service events: ${message.error.message}`, message.error.status, message.error.code));\n  }\n\n  complete(eventId: number): void {\n    this.updatePending(null, null);\n    this.established = true;\n    this.localObject._advanceLastEventId(eventId);\n  }\n\n  setSubscriptionState(newState) {\n    this.localObject._setSubscriptionState(newState);\n  }\n}\n\ninterface SubscriptionsServices {\n  config: Configuration;\n  network: Network;\n}\n\ntype Action = 'establish' | 'cancel' | null;\n\ninterface PokeBatch {\n  action: Action;\n  subscriptions: SubscribedEntity[];\n}\n\ntype PokeReason = 'ttl' | 'reconnect';\n\n/**\n * @class Subscriptions\n * @classdesc A manager which, in batches of varying size, continuously persists the\n *      subscription intent of the caller to the Sync backend until it achieves a\n *      converged state.\n */\nclass Subscriptions {\n  private services: SubscriptionsServices;\n\n  // This is always the full set of subscribables (SubscribedEntity instances) intended by\n  // the client. At any point, whatever the state of these subscriptions on the server, this\n  // is the intent of the user to which the SDK must converge.\n  private subscriptions: Map<string, SubscribedEntity>;\n\n  // This includes the set of subscribables (SubscribedEntity instances) for whom a request\n  // has been dispatched (whether or not this particular request ultimately succeeds) to\n  // establish a live subscription. Entities are removed when the corresponding \"cancel\"\n  // request is dispatched.\n  private persisted: Map<string, SubscribedEntity>;\n\n  private latestPokeResponseArrivalTimestampByCorrelationId: Map<number, number>;\n\n  private backoff: Backoff;\n\n  private isConnected: boolean = false;\n\n  private maxBatchSize: number = 100;\n\n  // If the server includes a `ttl_in_s` attribute in the poke response, subscriptionTtlTimer is started for that duration\n  // such that when it fires, it repokes the entire sync set (i.e., emulates a reconnect). Every reconnect resets the timer.\n  // After the timer has fired, the first poke request includes a `reason: ttl` attribute in the body.\n  private subscriptionTtlTimer: any | null = null;\n  private pendingPokeReason: PokeReason = null;\n\n  /**\n   * @constructor\n   * Prepares a new Subscriptions manager object with zero subscribed or persisted subscriptions.\n   *\n   * @param {object} config may include a key 'backoffConfig', wherein any of the parameters\n   *      of Backoff.exponential (from npm 'backoff') are valid and will override the defaults.\n   *\n   * @param {Network} must be a viable running Sync Network object, useful for routing requests.\n   */\n  constructor(services: SubscriptionsServices) {\n    this.services = services;\n    this.subscriptions = new Map<string, SubscribedEntity>();\n    this.persisted = new Map<string, SubscribedEntity>();\n    this.latestPokeResponseArrivalTimestampByCorrelationId = new Map<number, number>();\n\n    const defaultBackoffConfig = {\n      randomisationFactor: 0.2,\n      initialDelay: 100,\n      maxDelay: 2 * 60 * 1000\n    };\n    this.backoff = Backoff.exponential(Object.assign(defaultBackoffConfig, this.services.config.backoffConfig));\n\n    // This block is triggered by #_persist. Every request is executed in a series of (ideally 1)\n    // backoff 'ready' event, at which point a new subscription set is calculated.\n    this.backoff.on('ready', () => {\n      let {action: action, subscriptions: subscriptionRequests} = this.getSubscriptionUpdateBatch();\n      if (action) {\n        this.applyNewSubscriptionUpdateBatch(action, subscriptionRequests);\n      } else {\n        this.backoff.reset();\n        log.debug('All subscriptions resolved.');\n      }\n    });\n  }\n\n  private getSubscriptionUpdateBatch(): PokeBatch {\n    function subtract(these: Map<string, SubscribedEntity>, those: Map<string, SubscribedEntity>, action: Action, limit) {\n      let result = [];\n      for (let [thisKey, thisValue] of these) {\n        const otherValue = those.get(thisKey);\n        if (!otherValue && action !== thisValue.pendingAction && !thisValue.rejectedWithError) {\n          result.push(thisValue);\n          if (limit && result.length >= limit) {\n            break;\n          }\n        }\n      }\n      return result;\n    }\n\n    let listToAdd = subtract(this.subscriptions, this.persisted, 'establish', this.maxBatchSize);\n    if (listToAdd.length > 0) {\n      return {action: 'establish', subscriptions: listToAdd};\n    }\n\n    let listToRemove = subtract(this.persisted, this.subscriptions, 'cancel', this.maxBatchSize);\n    if (listToRemove.length > 0) {\n      return {action: 'cancel', subscriptions: listToRemove};\n    }\n\n    return {action: null, subscriptions: null};\n  }\n\n  private persist() {\n    this.backoff.backoff();\n  }\n\n  private async applyNewSubscriptionUpdateBatch(action, requests: SubscribedEntity[]) {\n    if (!this.isConnected) {\n      log.debug(`Twilsock connection (required for subscription) not ready; waiting…`);\n      this.backoff.reset();\n      return;\n    }\n\n    // Keeping in mind that events may begin flowing _before_ we receive the response\n    requests = this.processLocalActions(action, requests);\n\n    const correlationId = new Date().getTime();\n    for (const subscribed of requests) {\n      this.recordActionAttemptOn(subscribed, action, correlationId);\n    }\n\n    let reason: PokeReason = this.pendingPokeReason;\n    this.pendingPokeReason = null;\n\n    // Send this batch to the service\n    try {\n      let response = await this.request(action, correlationId, reason, requests);\n\n      let newMaxBatchSize = response.body.max_batch_size;\n      if (!isNaN(parseInt(newMaxBatchSize)) && isFinite(newMaxBatchSize) && newMaxBatchSize > 0) {\n        this.maxBatchSize = newMaxBatchSize;\n      }\n\n      if (!this.subscriptionTtlTimer) {\n        let subscriptionTtlInS = response.body.ttl_in_s;\n        let isNumeric = !isNaN(parseFloat(subscriptionTtlInS)) && isFinite(subscriptionTtlInS);\n        let isValidTtl = isNumeric && subscriptionTtlInS > 0;\n        if (isValidTtl) {\n          this.subscriptionTtlTimer = setTimeout(() => this.onSubscriptionTtlElapsed(), subscriptionTtlInS * 1000);\n        }\n      }\n\n      if (action === 'establish') {\n        const estimatedDeliveryInMs = response.body.estimated_delivery_in_ms;\n        let isNumeric = !isNaN(parseFloat(estimatedDeliveryInMs)) && isFinite(estimatedDeliveryInMs);\n        let isValidTimeout = isNumeric && estimatedDeliveryInMs > 0;\n        if (isValidTimeout) {\n          setTimeout(() => this.verifyPokeDelivery(correlationId, estimatedDeliveryInMs, requests), estimatedDeliveryInMs);\n        } else {\n          log.error(`Invalid timeout: ${estimatedDeliveryInMs}`);\n        }\n        requests.filter(r => r.pendingCorrelationId === correlationId)\n          .forEach(r => r.setSubscriptionState('response_in_flight'));\n      }\n      this.backoff.reset();\n    } catch (e) {\n      for (const attemptedSubscription of requests) {\n        this.recordActionFailureOn(attemptedSubscription, action);\n      }\n\n      if (e instanceof TransportUnavailableError) {\n        log.debug(`Twilsock connection (required for subscription) not ready (c:${correlationId}); waiting…`);\n        this.backoff.reset();\n      } else {\n        log.debug(`Failed an attempt to ${action} subscriptions (c:${correlationId}); retrying`, e);\n        this.persist();\n      }\n    }\n  }\n\n  private verifyPokeDelivery(correlationId: number, estimatedDeliveryInMs: number, requests: SubscribedEntity[]) {\n    const lastReceived = this.latestPokeResponseArrivalTimestampByCorrelationId.get(correlationId);\n    const silencePeriod = lastReceived ? (new Date().getTime() - lastReceived)\n      : estimatedDeliveryInMs;\n    if (silencePeriod >= estimatedDeliveryInMs) {\n      // If we haven't received _any_ responses from that poke request for the duration of estimated_delivery_in_ms, poke again\n      requests\n        .filter(r => r.pendingCorrelationId === correlationId)\n        .forEach(r => {\n          r.updatePending(null, null);\n          r.retryCount++;\n          this.persisted.delete(r.sid);\n        });\n      this.persist();\n      this.latestPokeResponseArrivalTimestampByCorrelationId.delete(correlationId);\n    } else {\n      // Otherwise, the poke responses are probably in transit and we should wait for them\n      const timeoutExtension = estimatedDeliveryInMs - silencePeriod;\n      setTimeout(() => this.verifyPokeDelivery(correlationId, estimatedDeliveryInMs, requests), timeoutExtension);\n    }\n  }\n\n  private processLocalActions(action, requests) {\n    if (action === 'cancel') {\n      return requests.filter(request => !request.rejectedWithError);\n    }\n    return requests;\n  }\n\n  private recordActionAttemptOn(attemptedSubscription: SubscribedEntity, action, correlationId) {\n    attemptedSubscription.setSubscriptionState('request_in_flight');\n    if (action === 'establish') {\n      this.persisted.set(attemptedSubscription.sid, attemptedSubscription);\n      attemptedSubscription.updatePending(action, correlationId);\n    } else { // cancel\n      let persistedSubscription = this.persisted.get(attemptedSubscription.sid);\n      if (persistedSubscription) {\n        persistedSubscription.updatePending(action, correlationId);\n      }\n    }\n  }\n\n  private recordActionFailureOn(attemptedSubscription: SubscribedEntity, action) {\n    attemptedSubscription.setSubscriptionState('none');\n    attemptedSubscription.updatePending(null, null);\n    if (action === 'establish') {\n      this.persisted.delete(attemptedSubscription.sid);\n    }\n  }\n\n  private request(action, correlationId, reason: PokeReason, objects: SubscribedEntity[]) {\n    let requests = objects.map(object => ({\n        object_sid: object.sid,\n        object_type: object.type,\n        last_event_id: action === 'establish' ? object.lastEventId : undefined,\n        index_name: action === 'establish' ? object.indexName : undefined,\n        query_string: action === 'establish' ? object.queryString : undefined,\n      })\n    );\n    let retriedRequests = objects.filter(a => a.retryCount > 0).length;\n\n    log.debug(`Attempting '${action}' request (c:${correlationId}):`, requests);\n    const requestBody: any = {\n      event_protocol_version: 4,\n      action,\n      correlation_id: correlationId,\n      retried_requests: retriedRequests,\n      ttl_in_s: -1,\n      requests\n    };\n    if (reason === 'ttl') {\n      requestBody.reason = reason;\n    }\n\n    return this.services.network.post(this.services.config.subscriptionsUri, requestBody);\n  }\n\n  /**\n   * Establishes intent to be subscribed to this entity. That subscription will be effected\n   * asynchronously.\n   * If subscription to the given sid already exists, it will be overwritten.\n   *\n   * @param {String} sid should be a well-formed SID, uniquely identifying a single instance of a Sync entity.\n   * @param {Object} entity should represent the (singular) local representation of this entity.\n   *      Incoming events and modifications to the entity will be directed at the _update() function\n   *      of this provided reference.\n   *\n   * @return undefined\n   */\n  add(sid: string, entity: SyncEntity): void {\n    log.debug(`Establishing intent to subscribe to ${sid}`);\n    const existingSubscription = this.subscriptions.get(sid);\n    if (existingSubscription && entity && existingSubscription.lastEventId === entity.lastEventId) {\n      // If last event id is the same as before - we're fine\n      return;\n    }\n\n    this.persisted.delete(sid);\n    this.subscriptions.set(sid, new SubscribedEntity(entity));\n    this.persist();\n  }\n\n  /**\n   * Establishes the caller's intent to no longer be subscribed to this entity. Following this\n   * call, no further events shall be routed to the local representation of the entity, even\n   * though a server-side subscription may take more time to actually terminate.\n   *\n   * @param {string} sid should be any well-formed SID, uniquely identifying a Sync entity.\n   *      This call only has meaningful effect if that entity is subscribed at the\n   *      time of call. Otherwise does nothing.\n   *\n   * @return undefined\n   */\n  remove(sid: string): void {\n    log.debug(`Establishing intent to unsubscribe from ${sid}`);\n    const removed = this.subscriptions.delete(sid);\n    if (removed) {\n      this.persist();\n    }\n  }\n\n  /**\n   * The point of ingestion for remote incoming messages (e.g. new data was written to a map\n   * to which we are subscribed).\n   *\n   * @param {object} message is the full, unaltered body of the incoming notification.\n   *\n   * @return undefined\n   */\n  acceptMessage(message: any, isStrictlyOrdered: boolean): void {\n    log.trace('Subscriptions received', message);\n\n    const eventType = message.event_type;\n    const events = typeof message.events !== 'undefined'\n      ? message.events\n      : [message.event];\n    const correlationId = message.correlation_id;\n\n    if (correlationId) {\n      this.latestPokeResponseArrivalTimestampByCorrelationId.set(correlationId, new Date().getTime());\n    }\n\n    for (const event of events) {\n      let matchedEventType;\n      switch (message.event_type) {\n        case 'subscription_established':\n          this.applySubscriptionEstablishedMessage(event, correlationId);\n          break;\n        case 'subscription_canceled':\n          this.applySubscriptionCancelledMessage(event, correlationId);\n          break;\n        case 'subscription_failed':\n          this.applySubscriptionFailedMessage(event, correlationId);\n          break;\n        case (matchedEventType = eventType.match(/^(?:map|list|document|stream|live_query)_/) || {}).input: {\n          let typedSid;\n          switch (matchedEventType[0]) {\n            case 'map_':\n              typedSid = event.map_sid;\n              break;\n            case 'list_':\n              typedSid = event.list_sid;\n              break;\n            case 'document_':\n              typedSid = event.document_sid;\n              break;\n            case 'stream_':\n              typedSid = event.stream_sid;\n              break;\n            case 'live_query_':\n              typedSid = event.query_id;\n              // hack to mark replay events for LiveQuery as strictly ordered, due to lack of special type of notification for them\n              // (normally only replay events would have `twilio.sync.event` type, but LiveQuery non-replay events were also assigned\n              // to this type in legacy clients, which we have to support now; hence a hack)\n              isStrictlyOrdered = false; // explicitly override it due to code in router.ts does not know about LiveQueries\n              if (message.strictly_ordered === true) {\n                isStrictlyOrdered = true;\n              }\n              break;\n            default:\n              typedSid = undefined;\n          }\n\n          this.applyEventToSubscribedEntity(typedSid, event, eventType, isStrictlyOrdered);\n          break;\n        }\n        default:\n          log.debug(`Dropping unknown message type ${eventType}`);\n          break;\n      }\n    }\n  }\n\n  private applySubscriptionEstablishedMessage(message, correlationId) {\n    const sid = message.object_sid;\n    let subscriptionIntent = this.persisted.get(message.object_sid);\n    if (subscriptionIntent && subscriptionIntent.pendingCorrelationId === correlationId) {\n      if (message.replay_status === 'interrupted') {\n        log.debug(`Event Replay for subscription to ${sid} (c:${correlationId}) interrupted; continuing eagerly.`);\n        subscriptionIntent.updatePending(null, null);\n        this.persisted.delete(subscriptionIntent.sid);\n        this.backoff.reset();\n      } else if (message.replay_status === 'completed') {\n        log.debug(`Event Replay for subscription to ${sid} (c:${correlationId}) completed. Subscription is ready.`);\n        subscriptionIntent.complete(message.last_event_id);\n        this.persisted.set(message.object_sid, subscriptionIntent);\n        subscriptionIntent.setSubscriptionState('established');\n        this.backoff.reset();\n      }\n    } else {\n      log.debug(`Late message for ${message.object_sid} (c:${correlationId}) dropped.`);\n    }\n    this.persist();\n  }\n\n  private applySubscriptionCancelledMessage(message, correlationId) {\n    let persistedSubscription = this.persisted.get(message.object_sid);\n    if (persistedSubscription && persistedSubscription.pendingCorrelationId === correlationId) {\n      persistedSubscription.updatePending(null, null);\n      persistedSubscription.setSubscriptionState('none');\n      this.persisted.delete(message.object_sid);\n    } else {\n      log.debug(`Late message for ${message.object_sid} (c:${correlationId}) dropped.`);\n    }\n    this.persist();\n  }\n\n  private applySubscriptionFailedMessage(message, correlationId) {\n    const sid = message.object_sid;\n    let subscriptionIntent = this.subscriptions.get(sid);\n    let subscription = this.persisted.get(sid);\n    if (subscriptionIntent && subscription) {\n      if (subscription.pendingCorrelationId === correlationId) {\n        log.error(`Failed to subscribe on ${subscription.sid}`, message.error);\n        subscription.markAsFailed(message);\n        subscription.setSubscriptionState('none');\n      }\n    } else if (!subscriptionIntent && subscription) {\n      this.persisted.delete(sid);\n      subscription.setSubscriptionState('none');\n    }\n\n    this.persist();\n  }\n\n  private applyEventToSubscribedEntity(sid: string, event: any, eventType: string, isStrictlyOrdered: boolean): void {\n    if (!sid) {\n      return;\n    }\n\n    // Looking for subscription descriptor to check if poke has been completed\n    isStrictlyOrdered = isStrictlyOrdered || (() => {\n      let subscription = this.persisted.get(sid);\n      return subscription && subscription.isEstablished;\n    })();\n\n    // Still searching for subscriptionIntents. User could remove subscription already\n    let subscriptionIntent = this.subscriptions.get(sid);\n    if (subscriptionIntent) {\n      event.type = eventType;\n      subscriptionIntent.update(event, isStrictlyOrdered);\n    } else {\n      log.debug(`Message dropped for SID '${sid}', for which there is no subscription.`);\n    }\n  }\n\n  onConnectionStateChanged(isConnected: boolean) {\n    this.isConnected = isConnected;\n    if (isConnected) {\n      this.poke('reconnect');\n    }\n  }\n\n  private onSubscriptionTtlElapsed() {\n    if (this.isConnected) {\n      this.poke('ttl');\n    }\n  }\n\n  /**\n   * Prompts a playback of any missed changes made to any subscribed object. This method\n   * should be invoked whenever the connectivity layer has experienced cross-cutting\n   * delivery failures that would affect the entire local sync set. Any tangible result\n   * of this operation will result in calls to the _update() function of subscribed\n   * Sync entities.\n   */\n  private poke(reason: PokeReason) {\n    log.debug(`Triggering event replay for all subscriptions, reason=${reason}`);\n    this.pendingPokeReason = reason;\n    if (this.subscriptionTtlTimer) {\n      clearTimeout(this.subscriptionTtlTimer);\n      this.subscriptionTtlTimer = null;\n    }\n\n    let failedSubscriptions = [];\n\n    for (let it of this.persisted.values()) {\n      it.reset();\n      if (it.rejectedWithError) {\n        failedSubscriptions.push(it);\n      }\n    }\n\n    this.persisted.clear();\n    for (let it of failedSubscriptions) {\n      this.persisted.set(it.sid, it);\n    }\n    this.persist();\n  }\n\n  /**\n   * Stops all communication, clears any subscription intent, and returns.\n   */\n  shutdown() {\n    this.backoff.reset();\n    this.subscriptions.clear();\n  }\n}\n\nexport { SubscriptionsServices, Subscriptions };\n"],"names":["SyncError","Backoff","log","TransportUnavailableError"],"mappings":"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"}