{"version":3,"file":"backoffretrier.js","sources":["../src/backoffretrier.ts"],"sourcesContent":["import { EventEmitter } from \"events\";\nimport { Retrier } from \"@twilio/operation-retrier\";\nimport { ReplayEventEmitter } from \"@twilio/replay-event-emitter\";\n\n/**\n * Retrier with backoff override capability\n */\ntype RetrierOptionsType = {\n  min: number;\n  max: number;\n  initial?: number;\n  maxAttemptsCount?: number;\n  maxAttemptsTime?: number;\n  randomness?: number;\n};\n\ntype RetrierEvents = {\n  attempt: () => void;\n  failed: (error: Error) => void;\n};\n\nclass BackoffRetrier extends ReplayEventEmitter<RetrierEvents> {\n  private readonly options;\n  private newBackoff: number | null = null;\n  private usedBackoff: number | null = null;\n\n  private retrier: Retrier | null = null;\n\n  public get inProgress(): boolean {\n    return !!this.retrier;\n  }\n\n  constructor(options: RetrierOptionsType) {\n    super();\n    this.options = options ? { ...options } : {};\n  }\n\n  /**\n   * Should be called once per attempt series to start retrier.\n   */\n  public start(): void {\n    if (this.inProgress) {\n      throw new Error(\n        \"Already waiting for next attempt, call finishAttempt(success : boolean) to finish it\"\n      );\n    }\n    this.createRetrier();\n  }\n\n  /**\n   * Should be called to stop retrier entirely.\n   */\n  public stop(): void {\n    this.cleanRetrier();\n    this.newBackoff = null;\n    this.usedBackoff = null;\n  }\n\n  /**\n   * Modifies backoff for next attempt.\n   * Expected behavior:\n   * - If there was no backoff passed previously reschedulling next attempt to given backoff\n   * - If previous backoff was longer then ignoring this one.\n   * - If previous backoff was shorter then reschedulling with this one.\n   * With or without backoff retrier will keep growing normally.\n   * @param delay delay of next attempts in ms.\n   */\n  public modifyBackoff(delay: number): void {\n    this.newBackoff = delay;\n  }\n\n  /**\n   * Mark last emmited attempt as failed, initiating either next of fail if limits were hit.\n   */\n  public attemptFailed(): void {\n    if (!this.inProgress) {\n      throw new Error(\"No attempt is in progress\");\n    }\n\n    if (this.newBackoff) {\n      const shouldUseNewBackoff =\n        !this.usedBackoff || this.usedBackoff < this.newBackoff;\n      if (shouldUseNewBackoff) {\n        this.createRetrier();\n      } else {\n        this.retrier?.failed(new Error());\n      }\n    } else {\n      this.retrier?.failed(new Error());\n    }\n  }\n\n  public cancel(): void {\n    this.retrier?.cancel();\n  }\n\n  private cleanRetrier(): void {\n    this.retrier?.removeAllListeners();\n    this.retrier?.cancel();\n    this.retrier = null;\n  }\n\n  private getRetryPolicy(): RetrierOptionsType {\n    const clone = { ...this.options };\n\n    if (this.newBackoff) {\n      clone.min = this.newBackoff;\n      clone.max =\n        this.options.max && this.options.max > this.newBackoff\n          ? this.options.max\n          : this.newBackoff;\n    }\n\n    // As we're always skipping first attempt we should add one extra if limit is present\n    clone.maxAttemptsCount = this.options.maxAttemptsCount\n      ? this.options.maxAttemptsCount + 1\n      : undefined;\n\n    return clone;\n  }\n\n  private createRetrier(): void {\n    this.cleanRetrier();\n    const retryPolicy = this.getRetryPolicy();\n    this.retrier = new Retrier(retryPolicy);\n\n    this.retrier.once(\"attempt\", () => {\n      this.retrier?.on(\"attempt\", () => this.emit(\"attempt\"));\n      this.retrier?.failed(new Error(\"Skipping first attempt\"));\n    });\n\n    this.retrier.on(\"failed\", (err) => this.emit(\"failed\", err));\n\n    this.usedBackoff = this.newBackoff;\n    this.newBackoff = null;\n\n    this.retrier.start();\n    // .catch(err => {});\n  }\n}\n\nexport { BackoffRetrier };\n"],"names":["ReplayEventEmitter","Retrier"],"mappings":"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"}