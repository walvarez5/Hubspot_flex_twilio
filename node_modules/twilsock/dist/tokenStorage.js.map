{"version":3,"file":"tokenStorage.js","sources":["../src/tokenStorage.ts"],"sourcesContent":["class TokenStorage {\n  private initializedFlag = \"twilio_twilsock_token_storage\";\n  private tokenStoragePrefix = \"twilio_continuation_token_\";\n  private static _instance: TokenStorage | null = null;\n\n  constructor() {\n    if (!TokenStorage._instance) {\n      this.initialize();\n      TokenStorage._instance = this;\n    }\n    return TokenStorage._instance;\n  }\n\n  public sessionStorage(): Storage | null {\n    try {\n      return global[\"sessionStorage\"];\n    } catch (err) {\n      return null;\n    }\n  }\n\n  public window(): Window | null {\n    try {\n      return global[\"window\"];\n    } catch (err) {\n      return null;\n    }\n  }\n\n  public storeToken(continuationToken: string, productId: string): void {\n    if (this.canStore()) {\n      this.sessionStorage.setItem(\n        this.getKeyName(productId),\n        continuationToken\n      );\n    }\n  }\n\n  public getStoredToken(productId: string): string | null {\n    if (!this.canStore()) {\n      return null;\n    }\n\n    return this.sessionStorage.getItem(this.getKeyName(productId));\n  }\n\n  private initialize(): void {\n    if (this.canStore()) {\n      const flag = this.sessionStorage.getItem(this.initializedFlag);\n\n      // Duplicated tab, cleaning up all stored keys\n      if (flag) {\n        this.clear();\n      }\n      this.sessionStorage.setItem(this.initializedFlag, \"true\");\n\n      // When leaving page or refreshing\n      const removeStorageItem = this.sessionStorage.removeItem;\n      this.window.addEventListener(\"unload\", () => {\n        removeStorageItem(this.initializedFlag);\n      });\n    }\n  }\n\n  public clear(): void {\n    if (this.canStore()) {\n      const keyToDelete: string[] = [];\n      for (let i = 0; i < this.sessionStorage.length; i++) {\n        const key = this.sessionStorage.key(i);\n        // We manually removed startsWith here due to some problems with babel polyfill setup.\n        // Restore it when we figure out what's wrong.\n        //if (key.startsWith(TokenStorage.tokenStoragePrefix)) {\n        if (key && key.indexOf(this.tokenStoragePrefix) === 0) {\n          keyToDelete.push(key);\n        }\n      }\n      const removeStorageItem = this.sessionStorage.removeItem;\n      keyToDelete.forEach((key) => removeStorageItem(key));\n      removeStorageItem(this.initializedFlag);\n    }\n  }\n\n  private getKeyName(productId: string) {\n    return `${this.tokenStoragePrefix}${productId}`;\n  }\n\n  private canStore(): this is TokenStorage & {\n    window: Window;\n    sessionStorage: Storage;\n  } {\n    return !!(this.sessionStorage && this.sessionStorage.length && this.window);\n  }\n}\n\nexport default new TokenStorage();\n"],"names":[],"mappings":"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"}