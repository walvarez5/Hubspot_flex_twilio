{"version":3,"file":"websocketchannel.js","sources":["../src/websocketchannel.ts"],"sourcesContent":["import { Channel } from \"./interfaces/channel\";\nimport { log } from \"./logger\";\nimport { ReplayEventEmitter } from \"@twilio/replay-event-emitter\";\nimport { CloseEvent } from \"ws\";\n\ntype WebSocketChannelEvents = {\n  connected: () => void;\n  message: (data: unknown) => void;\n  disconnected: (closeEvent: CloseEvent) => void;\n  socketError: (error: Error) => void;\n};\n\nclass WebSocketChannel\n  extends ReplayEventEmitter<WebSocketChannelEvents>\n  implements Channel\n{\n  private readonly WebSocket;\n  private socket: WebSocket | null = null;\n\n  constructor(private readonly url: string) {\n    super();\n    this.url = url;\n    this.WebSocket =\n      global[\"WebSocket\"] || global[\"MozWebSocket\"] || require(\"ws\");\n  }\n\n  public get isConnected(): boolean {\n    return !!this.socket && this.socket.readyState === 1;\n  }\n\n  public connect(): void {\n    log.trace(\"connecting to socket\");\n\n    let socket;\n\n    try {\n      socket = new this.WebSocket(this.url);\n    } catch (e) {\n      log.debug(`Socket error: ${this.url}`);\n      this.emit(\"socketError\", e);\n      return;\n    }\n\n    socket.binaryType = \"arraybuffer\";\n\n    socket.onopen = () => {\n      log.debug(`socket opened ${this.url}`);\n      this.emit(\"connected\");\n    };\n\n    socket.onclose = (e) => {\n      log.debug(\"socket closed\", e);\n      this.emit(\"disconnected\", e);\n    };\n\n    socket.onerror = (e) => {\n      log.debug(\"Socket error:\", e);\n      this.emit(\"socketError\", e);\n    };\n\n    socket.onmessage = (message: MessageEvent) => {\n      this.emit(\"message\", message.data);\n    };\n\n    this.socket = socket;\n  }\n\n  public send(message: ArrayBuffer): void | null {\n    return this.socket && this.socket.send(message);\n  }\n\n  close(): void {\n    log.trace(\"closing socket\");\n\n    if (this.socket) {\n      this.socket.onopen = null;\n      this.socket.onclose = null;\n      this.socket.onerror = null;\n      this.socket.onmessage = null;\n      try {\n        this.socket.close();\n      } finally {\n      }\n    }\n  }\n}\n\nexport { WebSocketChannel };\n"],"names":["ReplayEventEmitter","log"],"mappings":"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"}